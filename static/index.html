<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Knowledge Base</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        .chat-message { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .resizer {
            width: 16px;
            cursor: col-resize;
            background: linear-gradient(to right, transparent 6px, #e5e7eb 6px, #e5e7eb 10px, transparent 10px);
            position: relative;
            flex-shrink: 0;
            margin: 0 4px;
            align-self: stretch;
            z-index: 10;
        }
        .resizer:hover, .resizer.resizing {
            background: linear-gradient(to right, transparent 6px, #3b82f6 6px, #3b82f6 10px, transparent 10px);
        }
        .resizer::before {
            content: '‚ãÆ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            color: #9ca3af;
            font-weight: bold;
        }
        .resizer:hover::before, .resizer.resizing::before {
            color: #3b82f6;
        }
        .resizable-container {
            display: flex;
            gap: 0;
            align-items: stretch;
        }
        @media (max-width: 1024px) {
            .resizer { display: none; }
            .resizable-container { flex-direction: column; gap: 2rem; }
        }
        .folder-panel {
            max-height: 240px;
            overflow-y: auto;
            transition: max-height 0.3s ease, padding 0.3s ease;
            border-bottom: 1px solid #e5e7eb;
        }
        .dark .folder-panel { border-bottom-color: #374151; }
        .folder-panel.collapsed { max-height: 0; padding-top: 0; padding-bottom: 0; overflow: hidden; border-bottom: none; }
        .folder-item { cursor: pointer; transition: background 0.15s; border-radius: 0.375rem; }
        .folder-item:hover { background: rgba(59,130,246,0.08); }
        .folder-item.active { background: rgba(59,130,246,0.12); }
        .dark .folder-item:hover { background: rgba(59,130,246,0.15); }
        .dark .folder-item.active { background: rgba(59,130,246,0.2); }
        .conv-item { cursor: pointer; transition: background 0.15s; border-radius: 0.375rem; }
        .conv-item:hover { background: rgba(59,130,246,0.06); }
        .conv-item.active { background: rgba(59,130,246,0.12); }
        .dark .conv-item:hover { background: rgba(59,130,246,0.1); }
        .dark .conv-item.active { background: rgba(59,130,246,0.2); }
        .doc-filter-btn { cursor: pointer; transition: all 0.15s; }
        .doc-filter-btn:hover { background: rgba(59,130,246,0.1); }
        .doc-filter-btn.active { background: rgba(59,130,246,0.15); border-color: rgb(59,130,246); color: rgb(59,130,246); }
        .dark .doc-filter-btn.active { background: rgba(59,130,246,0.25); border-color: rgb(96,165,250); color: rgb(96,165,250); }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen transition-colors duration-200">
    <!-- Preview Modal -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                <h3 id="previewTitle" class="text-lg font-semibold dark:text-white truncate"></h3>
                <div class="flex gap-2">
                    <button id="downloadBtn" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Download</button>
                    <button onclick="closePreview()" class="px-3 py-1 bg-gray-300 dark:bg-gray-600 rounded hover:bg-gray-400 text-sm dark:text-white">Close</button>
                </div>
            </div>
            <div id="previewContent" class="p-4 overflow-auto flex-1 dark:text-gray-200"></div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4">
            <h2 id="authTitle" class="text-2xl font-bold mb-6 dark:text-white">Login</h2>
            <form id="authForm" class="space-y-4">
                <input type="text" id="username" placeholder="Username" required
                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="email" id="email" placeholder="Email" 
                    class="hidden w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="password" placeholder="Password" required
                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                    Login
                </button>
            </form>
            <p class="mt-4 text-center text-gray-600">
                <span id="authToggleText">Don't have an account?</span>
                <button id="authToggle" class="text-blue-600 hover:underline ml-1">Register</button>
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold text-gray-800 dark:text-white">üìö Legal Knowledge Base</h1>
                <div class="flex items-center gap-4">
                    <button id="darkModeToggle" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" title="Toggle dark mode">
                        <span id="darkModeIcon" class="text-lg">üåô</span>
                    </button>
                    <span id="userDisplay" class="text-gray-600 dark:text-gray-300"></span>
                    <button id="logoutBtn" class="text-red-600 hover:underline">Logout</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8">
            <div class="resizable-container">
                <!-- Documents Panel -->
                <div id="documentsPanel" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 order-2 lg:order-1 flex-shrink-0" style="width: 350px; min-width: 250px; max-width: 600px;">
                    <h2 class="text-lg font-semibold mb-4 dark:text-white">Documents</h2>
                    
                    <!-- Folder selector for upload -->
                    <div class="mb-2 flex items-center gap-2">
                        <select id="docFolderSelect" class="flex-1 px-2 py-1.5 text-sm border dark:border-gray-600 rounded dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="">General (No folder)</option>
                        </select>
                        <button onclick="promptNewDocFolder()" class="text-xs bg-green-600 text-white px-2 py-1.5 rounded hover:bg-green-700 whitespace-nowrap">+ Folder</button>
                    </div>
                    
                    <!-- Upload -->
                    <div class="mb-4">
                        <label class="block w-full cursor-pointer">
                            <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-3 text-center hover:border-blue-500 transition">
                                <p class="text-gray-500 dark:text-gray-400 text-sm">Click to upload (up to 100 files)</p>
                                <p class="text-xs text-gray-400 dark:text-gray-500">PDF, Word, Excel, PowerPoint (max 1GB each)</p>
                            </div>
                            <input type="file" id="fileInput" accept=".pdf,.docx,.xlsx,.pptx" class="hidden" multiple>
                        </label>
                    </div>

                    <!-- Document filter tabs -->
                    <div class="mb-2 flex items-center gap-1 flex-wrap" id="docFilterTabs">
                        <button onclick="filterDocsByFolder(null)" class="doc-filter-btn active text-xs px-2 py-1 rounded border dark:border-gray-600" data-folder="">All</button>
                    </div>
                    
                    <!-- Document List -->
                    <div id="documentList" class="space-y-2 overflow-y-auto" style="max-height: calc(100% - 200px);">
                        <p class="text-gray-500 dark:text-gray-400 text-sm">No documents yet</p>
                    </div>
                </div>

                <!-- Resizer Handle -->
                <div id="resizer" class="resizer hidden lg:block" title="Drag to resize"></div>

                <!-- Chat Panel -->
                <div id="chatPanel" class="bg-white dark:bg-gray-800 rounded-lg shadow flex flex-col order-1 lg:order-2 flex-1 overflow-hidden" style="height: 600px; min-width: 400px;">
                    <!-- Tab Headers -->
                    <div class="flex border-b dark:border-gray-700">
                        <button id="tabAskQuestions" onclick="switchTab('ask')" class="flex-1 px-4 py-3 text-sm font-medium border-b-2 border-blue-600 text-blue-600 dark:text-blue-400">
                            Ask Questions
                        </button>
                        <button id="tabAnalyzePleading" onclick="switchTab('analyze')" class="flex-1 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400">
                            Analyze Pleading
                        </button>
                    </div>
                    
                    <!-- Ask Questions Tab Content -->
                    <div id="askQuestionsContent" class="flex-1 flex flex-col overflow-hidden">
                        <!-- Conversation Controls Bar -->
                        <div class="flex items-center justify-between px-4 py-2 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-800" style="min-height: 40px;">
                            <div class="flex items-center gap-2 min-w-0">
                                <button onclick="toggleFolderPanel()" class="flex items-center gap-1 text-gray-600 dark:text-gray-300 hover:text-blue-600 flex-shrink-0" title="Toggle Topics">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                                    <span class="text-sm font-medium">Topics</span>
                                    <svg id="folderChevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <span id="activeFolderLabel" class="text-xs text-blue-600 dark:text-blue-400 font-medium truncate hidden"></span>
                                <span id="conversationLabel" class="text-xs text-gray-500 dark:text-gray-400 truncate">New conversation</span>
                            </div>
                            <div class="flex items-center gap-3 flex-shrink-0">
                                <button onclick="showCreateFolderInput()" class="text-xs text-green-600 dark:text-green-400 hover:underline whitespace-nowrap" title="New Topic">+ Topic</button>
                                <button onclick="startNewConversation()" class="text-xs text-blue-600 dark:text-blue-400 hover:underline whitespace-nowrap">+ Conversation</button>
                            </div>
                        </div>
                        <!-- Folder Panel (collapsible, above chat) -->
                        <div id="folderPanel" class="folder-panel bg-gray-50 dark:bg-gray-800 px-3 py-2">
                            <div id="createFolderRow" class="hidden mb-2">
                                <form onsubmit="createFolder(event)" class="flex gap-1">
                                    <input type="text" id="newFolderName" placeholder="Topic name..." class="flex-1 px-2 py-1 text-sm border dark:border-gray-600 rounded dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                                    <button type="submit" class="text-blue-600 text-sm font-medium">Add</button>
                                    <button type="button" onclick="hideCreateFolderInput()" class="text-gray-400 text-sm">X</button>
                                </form>
                            </div>
                            <div class="flex flex-wrap gap-1 mb-2">
                                <button onclick="selectFolder(null)" class="folder-item px-2 py-1 text-xs rounded flex items-center gap-1 ${!activeFolderId ? 'active' : ''}" id="allConvBtn">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                                    All
                                </button>
                            </div>
                            <div id="folderList"></div>
                            <div id="conversationList" class="mt-1"></div>
                        </div>
                        <!-- Chat Messages -->
                        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4">
                            <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                                <p>Upload documents and ask questions about your knowledge base.</p>
                            </div>
                        </div>
                        
                        <!-- Chat Input -->
                        <div class="p-4 border-t dark:border-gray-700">
                            <form id="chatForm" class="flex gap-2">
                                <input type="text" id="chatInput" placeholder="Ask a question..." 
                                    class="flex-1 px-4 py-2 border dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                    Send
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Analyze Pleading Tab Content -->
                    <div id="analyzePleadingContent" class="flex-1 flex flex-col overflow-hidden hidden">
                        <div class="p-4 border-b dark:border-gray-700">
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Upload a pleading or select one from your knowledge base. The system will extract legal issues and find supporting or contradicting evidence.</p>
                            
                            <!-- Upload new pleading option -->
                            <div class="mb-3">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Upload pleading (temporary - not saved to knowledge base)</label>
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <input type="file" id="pleadingFileInput" accept=".pdf,.docx,.doc,.xlsx,.xls,.pptx,.ppt" class="flex-1 px-3 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-sm file:mr-2 file:py-1 file:px-3 file:border-0 file:rounded file:bg-purple-100 file:text-purple-700 dark:file:bg-purple-900 dark:file:text-purple-300">
                                    <button onclick="analyzeUploadedPleading()" id="analyzeUploadBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 disabled:opacity-50 whitespace-nowrap flex-shrink-0">
                                        Analyze Upload
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Divider -->
                            <div class="flex items-center my-3">
                                <div class="flex-1 border-t dark:border-gray-600"></div>
                                <span class="px-3 text-sm text-gray-500 dark:text-gray-400">OR</span>
                                <div class="flex-1 border-t dark:border-gray-600"></div>
                            </div>
                            
                            <!-- Select from knowledge base -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select from knowledge base</label>
                                <div class="flex flex-col gap-2">
                                    <select id="pleadingSelect" class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                                        <option value="">-- Select a document to analyze --</option>
                                    </select>
                                    <button onclick="analyzePleading()" id="analyzeBtn" class="w-full sm:w-auto bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 disabled:opacity-50">
                                        Analyze Selected Document
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analysis Results -->
                        <div id="analysisResults" class="flex-1 overflow-y-auto p-4">
                            <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                                <p>Select a pleading document to analyze its legal issues.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = '';
        let token = localStorage.getItem('token');
        let isRegister = false;
        let chatSessionId = localStorage.getItem('chatSessionId') || null;
        let activeFolderId = localStorage.getItem('activeFolderId') ? parseInt(localStorage.getItem('activeFolderId')) : null;
        let activeFolderName = localStorage.getItem('activeFolderName') || null;
        let folders = [];

        // Auth functions
        function showAuth() {
            document.getElementById('authModal').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }

        function hideAuth() {
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        }

        function toggleAuthMode() {
            isRegister = !isRegister;
            document.getElementById('authTitle').textContent = isRegister ? 'Register' : 'Login';
            document.getElementById('email').classList.toggle('hidden', !isRegister);
            document.getElementById('authToggleText').textContent = isRegister ? 'Already have an account?' : "Don't have an account?";
            document.getElementById('authToggle').textContent = isRegister ? 'Login' : 'Register';
            document.querySelector('#authForm button').textContent = isRegister ? 'Register' : 'Login';
        }

        async function handleAuth(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const email = document.getElementById('email').value;

            try {
                if (isRegister) {
                    await fetch(`${API_BASE}/api/auth/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, email, password })
                    });
                }

                const formData = new URLSearchParams();
                formData.append('username', username);
                formData.append('password', password);

                const res = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (!res.ok) throw new Error('Login failed');

                const data = await res.json();
                token = data.access_token;
                localStorage.setItem('token', token);
                localStorage.setItem('username', username);
                
                hideAuth();
                document.getElementById('userDisplay').textContent = username;
                loadDocuments();
            } catch (err) {
                alert(err.message);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            token = null;
            showAuth();
        }

        // Document functions
        let allDocuments = [];
        let docFilterFolderId = null;

        async function loadDocuments() {
            try {
                const res = await fetch(`${API_BASE}/api/documents`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                allDocuments = await res.json();
                updateDocFolderSelect();
                updateDocFilterTabs();
                renderDocuments();
            } catch (err) {
                console.error(err);
            }
        }

        function updateDocFolderSelect() {
            const select = document.getElementById('docFolderSelect');
            const currentVal = select.value;
            let html = '<option value="">General (No folder)</option>';
            if (folders && folders.length > 0) {
                folders.forEach(f => {
                    html += `<option value="${f.id}">${f.name}</option>`;
                });
            }
            select.innerHTML = html;
            if (currentVal) select.value = currentVal;
        }

        function updateDocFilterTabs() {
            const container = document.getElementById('docFilterTabs');
            const folderNames = {};
            allDocuments.forEach(d => {
                if (d.folder_id && d.folder_name) {
                    folderNames[d.folder_id] = d.folder_name;
                }
            });
            if (folders) {
                folders.forEach(f => { folderNames[f.id] = f.name; });
            }
            let html = `<button onclick="filterDocsByFolder(null)" class="doc-filter-btn ${docFilterFolderId === null ? 'active' : ''} text-xs px-2 py-1 rounded border dark:border-gray-600">All</button>`;
            html += `<button onclick="filterDocsByFolder('unfiled')" class="doc-filter-btn ${docFilterFolderId === 'unfiled' ? 'active' : ''} text-xs px-2 py-1 rounded border dark:border-gray-600">General</button>`;
            Object.entries(folderNames).forEach(([id, name]) => {
                html += `<button onclick="filterDocsByFolder(${id})" class="doc-filter-btn ${docFilterFolderId == id ? 'active' : ''} text-xs px-2 py-1 rounded border dark:border-gray-600">${name}</button>`;
            });
            container.innerHTML = html;
        }

        function filterDocsByFolder(folderId) {
            docFilterFolderId = folderId;
            updateDocFilterTabs();
            renderDocuments();
        }

        function renderDocuments() {
            const list = document.getElementById('documentList');
            let docs = allDocuments;
            if (docFilterFolderId === 'unfiled') {
                docs = docs.filter(d => !d.folder_id);
            } else if (docFilterFolderId !== null) {
                docs = docs.filter(d => d.folder_id == docFilterFolderId);
            }

            if (docs.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-sm">No documents' + (docFilterFolderId ? ' in this folder' : ' yet') + '</p>';
                return;
            }
            
            const hasProcessing = docs.some(d => d.status === 'processing' || d.status === 'pending');
            if (hasProcessing) {
                setTimeout(loadDocuments, 2000);
            }
            
            list.innerHTML = docs.map(doc => {
                const folderBadge = doc.folder_name 
                    ? `<span class="text-xs bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 px-1.5 py-0.5 rounded">${doc.folder_name}</span>` 
                    : '';
                const statusDisplay = doc.status === 'processing' 
                    ? `<div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2 mt-1">
                         <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${doc.progress}%"></div>
                       </div>
                       <p class="text-xs text-blue-600">${doc.progress}% processing...</p>`
                    : doc.status === 'pending'
                    ? '<p class="text-xs text-yellow-600">Waiting to process...</p>'
                    : doc.status === 'ready'
                    ? '<p class="text-xs text-green-600">Ready - click to preview</p>'
                    : doc.status === 'error'
                    ? `<p class="text-xs text-red-600 cursor-pointer" onclick="event.stopPropagation(); showError('${escape(doc.error_message || 'Unknown error')}')">
                         Error - click for details
                       </p>`
                    : `<p class="text-xs text-gray-500 dark:text-gray-400">${doc.status}</p>`;
                
                const clickable = doc.status === 'ready' ? 'cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600' : '';
                const clickHandler = doc.status === 'ready' ? `onclick="previewDocument(${doc.id}, '${escape(doc.original_filename)}', '${doc.file_type}')"` : '';
                
                return `
                <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded ${clickable}" ${clickHandler}>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-1.5">
                            <p class="text-sm font-medium truncate dark:text-white">${doc.original_filename}</p>
                        </div>
                        <div class="flex items-center gap-1 mt-0.5">${folderBadge}${statusDisplay}</div>
                    </div>
                    <button onclick="event.stopPropagation(); deleteDocument(${doc.id})" class="text-red-500 hover:text-red-700 ml-2 text-lg">√ó</button>
                </div>`;
            }).join('');
        }

        async function promptNewDocFolder() {
            const name = prompt('Enter folder name:');
            if (!name || !name.trim()) return;
            try {
                const res = await fetch(`${API_BASE}/api/folders`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name.trim() })
                });
                if (!res.ok) throw new Error('Failed to create folder');
                const folder = await res.json();
                await loadFolders();
                updateDocFolderSelect();
                document.getElementById('docFolderSelect').value = folder.id;
            } catch (err) {
                alert('Error creating folder: ' + err.message);
            }
        }

        async function uploadFiles(files) {
            if (files.length > 100) {
                alert('Maximum 100 files allowed per upload');
                return;
            }
            
            const list = document.getElementById('documentList');
            const uploadingHtml = Array.from(files).map(file => `
                <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium truncate dark:text-white">${escapeHtml(file.name)}</p>
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2 mt-1">
                            <div class="bg-yellow-500 h-2 rounded-full animate-pulse" style="width: 100%"></div>
                        </div>
                        <p class="text-xs text-yellow-600">Uploading...</p>
                    </div>
                </div>
            `).join('');
            list.innerHTML = uploadingHtml + list.innerHTML;
            
            const formData = new FormData();
            for (const file of files) {
                formData.append('files', file);
            }
            const selectedFolderId = document.getElementById('docFolderSelect').value;
            if (selectedFolderId) {
                formData.append('folder_id', selectedFolderId);
            }

            try {
                const res = await fetch(`${API_BASE}/api/documents/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                if (res.ok) {
                    await loadDocuments();
                    setTimeout(loadDocuments, 2000);
                    setTimeout(loadDocuments, 5000);
                    setTimeout(loadDocuments, 10000);
                    setTimeout(loadDocuments, 20000);
                } else {
                    const error = await res.json();
                    alert('Upload failed: ' + (error.detail || 'Unknown error'));
                    loadDocuments();
                }
            } catch (err) {
                alert('Upload failed: ' + err.message);
                loadDocuments();
            }
        }

        function escape(str) {
            if (!str) return '';
            return str.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, ' ');
        }

        function showError(message) {
            const decoded = message.replace(/\\'/g, "'").replace(/\\"/g, '"');
            alert('Processing Error:\n\n' + decoded);
        }

        let currentPreviewDocId = null;
        
        async function previewDocumentById(docId, docName) {
            event.preventDefault();
            currentPreviewDocId = docId;
            document.getElementById('previewTitle').textContent = docName;
            document.getElementById('previewModal').classList.remove('hidden');
            document.getElementById('previewContent').innerHTML = '<p class="text-center text-gray-500">Loading preview...</p>';
            
            try {
                const res = await fetch(`${API_BASE}/api/documents/${docId}/preview?token=${token}`);
                if (res.ok) {
                    const contentType = res.headers.get('content-type');
                    if (contentType && contentType.includes('application/pdf')) {
                        document.getElementById('previewContent').innerHTML = `
                            <iframe src="${API_BASE}/api/documents/${docId}/preview?token=${token}" 
                                class="w-full h-full min-h-[500px]" frameborder="0"></iframe>`;
                    } else {
                        const data = await res.json();
                        document.getElementById('previewContent').innerHTML = `
                            <pre class="whitespace-pre-wrap text-sm font-mono bg-gray-100 dark:bg-gray-700 p-4 rounded overflow-auto">${escapeHtml(data.content)}</pre>`;
                    }
                } else {
                    document.getElementById('previewContent').innerHTML = '<p class="text-red-500">Preview not available for this document.</p>';
                }
            } catch (err) {
                document.getElementById('previewContent').innerHTML = '<p class="text-red-500">Failed to load preview.</p>';
            }
        }
        
        async function previewDocument(docId, filename, fileType) {
            currentPreviewDocId = docId;
            document.getElementById('previewTitle').textContent = filename;
            document.getElementById('previewModal').classList.remove('hidden');
            document.getElementById('previewContent').innerHTML = '<p class="text-center text-gray-500">Loading preview...</p>';
            
            try {
                if (fileType === 'pdf') {
                    document.getElementById('previewContent').innerHTML = `
                        <iframe src="${API_BASE}/api/documents/${docId}/preview?token=${token}" 
                            class="w-full h-full min-h-[500px]" frameborder="0"></iframe>`;
                } else {
                    const res = await fetch(`${API_BASE}/api/documents/${docId}/preview?token=${token}`);
                    if (res.ok) {
                        const data = await res.json();
                        document.getElementById('previewContent').innerHTML = `
                            <pre class="whitespace-pre-wrap text-sm font-mono bg-gray-100 dark:bg-gray-700 p-4 rounded overflow-auto">${escapeHtml(data.content)}</pre>`;
                    } else {
                        document.getElementById('previewContent').innerHTML = '<p class="text-red-500">Preview not available for this file type.</p>';
                    }
                }
            } catch (err) {
                document.getElementById('previewContent').innerHTML = '<p class="text-red-500">Failed to load preview.</p>';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function closePreview() {
            document.getElementById('previewModal').classList.add('hidden');
            currentPreviewDocId = null;
        }

        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (currentPreviewDocId) {
                window.open(`${API_BASE}/api/documents/${currentPreviewDocId}/download?token=${token}`, '_blank');
            }
        });

        function initDarkMode() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeIcon').textContent = '‚òÄÔ∏è';
            }
        }

        document.getElementById('darkModeToggle').addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark);
            document.getElementById('darkModeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        });

        initDarkMode();

        async function deleteDocument(id) {
            if (!confirm('Delete this document?')) return;
            try {
                await fetch(`${API_BASE}/api/documents/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadDocuments();
            } catch (err) {
                alert('Delete failed');
            }
        }

        // Chat functions
        function addMessage(content, isUser, sources = []) {
            const container = document.getElementById('chatMessages');
            const welcome = container.querySelector('.text-center');
            if (welcome) welcome.remove();

            const div = document.createElement('div');
            div.className = `chat-message ${isUser ? 'text-right' : ''}`;
            
            let html = `
                <div class="inline-block max-w-[80%] ${isUser ? 'bg-blue-600 text-white' : 'bg-gray-100 dark:bg-gray-700 dark:text-gray-200'} rounded-lg p-3">
                    <p class="whitespace-pre-wrap">${content}</p>
                </div>
            `;
            
            if (sources.length > 0) {
                // Collect unique sources with their page numbers
                const uniqueSources = sources.reduce((acc, s) => {
                    const existing = acc.find(x => x.doc_id === s.doc_id);
                    if (!existing) {
                        acc.push({...s, all_pages: s.page_numbers || []});
                    } else {
                        // Merge page numbers
                        const newPages = s.page_numbers || [];
                        newPages.forEach(p => {
                            if (!existing.all_pages.includes(p)) existing.all_pages.push(p);
                        });
                    }
                    return acc;
                }, []);
                
                const sourceLinks = uniqueSources.map(s => {
                    const folderBadge = s.folder_name 
                        ? `<span class="text-xs bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 px-1 py-0.5 rounded ml-1">${escapeHtml(s.folder_name)}</span>` 
                        : '';
                    return `<a href="#" onclick="previewDocumentById(${s.doc_id}, '${escape(s.doc_name || s.title)}')" class="text-blue-600 dark:text-blue-400 hover:underline">${escapeHtml(s.doc_name || s.title)}</a>${folderBadge}`;
                }).join(', ');
                
                html += `
                    <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                        Sources: ${sourceLinks}
                    </div>
                `;
                
                // Add page image thumbnails
                const pageImages = [];
                uniqueSources.forEach(s => {
                    let pages = s.all_pages || [];
                    // Default to page 1 if no specific pages referenced
                    if (pages.length === 0) {
                        pages = [1];
                    }
                    pages.slice(0, 3).forEach(pageNum => {  // Limit to 3 pages per source
                        pageImages.push({
                            doc_id: s.doc_id,
                            doc_name: s.doc_name,
                            page: pageNum
                        });
                    });
                });
                
                if (pageImages.length > 0) {
                    html += `
                        <div class="mt-3 flex flex-wrap gap-2">
                            ${pageImages.slice(0, 4).map(p => `
                                <div class="source-page-thumbnail cursor-pointer border dark:border-gray-600 rounded overflow-hidden" 
                                     onclick="showPageImage(${p.doc_id}, ${p.page}, '${escape(p.doc_name)}')"
                                     title="${escapeHtml(p.doc_name)} - Page ${p.page}">
                                    <img src="${API_BASE}/api/documents/${p.doc_id}/page/${p.page}/image?token=${token}" 
                                         alt="Page ${p.page}" 
                                         class="w-24 h-32 object-cover object-top bg-white"
                                         onerror="this.parentElement.style.display='none'">
                                    <div class="text-xs text-center bg-gray-200 dark:bg-gray-600 py-1">Page ${p.page}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }
            
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        function showPageImage(docId, pageNum, docName) {
            // Open a modal to show full-size page image
            document.getElementById('previewTitle').textContent = `${docName} - Page ${pageNum}`;
            document.getElementById('previewModal').classList.remove('hidden');
            currentPreviewDocId = docId;
            document.getElementById('previewContent').innerHTML = `
                <img src="${API_BASE}/api/documents/${docId}/page/${pageNum}/image?token=${token}" 
                     alt="Page ${pageNum}" 
                     class="max-w-full max-h-[70vh] mx-auto border shadow-lg">
            `;
        }

        function showThinkingIndicator() {
            const container = document.getElementById('chatMessages');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.id = 'thinkingIndicator';
            thinkingDiv.className = 'chat-message flex justify-start';
            thinkingDiv.innerHTML = `
                <div class="max-w-[80%] p-3 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                    <div class="flex items-center gap-2">
                        <div class="flex gap-1">
                            <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0ms;"></span>
                            <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 150ms;"></span>
                            <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 300ms;"></span>
                        </div>
                        <span class="text-sm text-gray-500 dark:text-gray-400">Searching knowledge base...</span>
                    </div>
                </div>
            `;
            container.appendChild(thinkingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function hideThinkingIndicator() {
            const indicator = document.getElementById('thinkingIndicator');
            if (indicator) indicator.remove();
        }

        async function handleChat(e) {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            const query = input.value.trim();
            if (!query) return;

            addMessage(query, true);
            input.value = '';
            
            showThinkingIndicator();
            document.getElementById('chatInput').disabled = true;

            try {
                const body = { query };
                if (chatSessionId) body.session_id = chatSessionId;
                if (activeFolderId) body.folder_id = activeFolderId;
                
                const res = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                hideThinkingIndicator();
                const data = await res.json();
                
                if (data.session_id) {
                    chatSessionId = data.session_id;
                    localStorage.setItem('chatSessionId', chatSessionId);
                    updateConversationLabel(query);
                    if (activeFolderId) {
                        loadFolders().then(() => renderFolderConversations());
                    }
                }
                
                addMessage(data.answer, false, data.sources);
            } catch (err) {
                hideThinkingIndicator();
                addMessage('Error: ' + err.message, false);
            } finally {
                document.getElementById('chatInput').disabled = false;
                document.getElementById('chatInput').focus();
            }
        }
        
        function startNewConversation() {
            chatSessionId = null;
            localStorage.removeItem('chatSessionId');
            const container = document.getElementById('chatMessages');
            container.innerHTML = `
                <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                    <p>Upload documents and ask questions about your knowledge base.</p>
                </div>
            `;
            document.getElementById('conversationLabel').textContent = 'New conversation';
            renderFolderConversations();
        }
        
        function updateConversationLabel(firstMessage) {
            const label = document.getElementById('conversationLabel');
            const preview = firstMessage.length > 50 ? firstMessage.substring(0, 50) + '...' : firstMessage;
            label.textContent = preview;
        }

        function toggleFolderPanel() {
            const panel = document.getElementById('folderPanel');
            const chevron = document.getElementById('folderChevron');
            panel.classList.toggle('collapsed');
            if (panel.classList.contains('collapsed')) {
                chevron.style.transform = 'rotate(-90deg)';
                localStorage.setItem('folderPanelOpen', 'false');
            } else {
                chevron.style.transform = '';
                localStorage.setItem('folderPanelOpen', 'true');
            }
        }

        function showCreateFolderInput() {
            document.getElementById('createFolderRow').classList.remove('hidden');
            document.getElementById('newFolderName').focus();
        }

        function hideCreateFolderInput() {
            document.getElementById('createFolderRow').classList.add('hidden');
            document.getElementById('newFolderName').value = '';
        }

        async function createFolder(e) {
            e.preventDefault();
            const name = document.getElementById('newFolderName').value.trim();
            if (!name) return;
            try {
                const res = await fetch(`${API_BASE}/api/folders`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (!res.ok) throw new Error('Failed to create topic');
                const folder = await res.json();
                hideCreateFolderInput();
                await loadFolders();
                selectFolder(folder.id, folder.name);
            } catch (err) {
                alert('Error creating topic: ' + err.message);
            }
        }

        async function loadFolders() {
            if (!token) return;
            try {
                const res = await fetch(`${API_BASE}/api/folders`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) return;
                folders = await res.json();
                renderFolders();
            } catch (err) {
                console.error('Error loading folders:', err);
            }
        }

        function renderFolders() {
            renderFolderConversations();
        }

        async function selectFolder(folderId, folderName) {
            activeFolderId = folderId;
            activeFolderName = folderName || null;
            if (folderId) {
                localStorage.setItem('activeFolderId', folderId);
                localStorage.setItem('activeFolderName', folderName);
            } else {
                localStorage.removeItem('activeFolderId');
                localStorage.removeItem('activeFolderName');
            }
            updateActiveFolderLabel();
            chatSessionId = null;
            localStorage.removeItem('chatSessionId');
            const container = document.getElementById('chatMessages');
            container.innerHTML = `
                <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                    <p>Upload documents and ask questions about your knowledge base.</p>
                </div>
            `;
            document.getElementById('conversationLabel').textContent = 'New conversation';
            await renderFolderConversations();
        }

        function updateActiveFolderLabel() {
            const label = document.getElementById('activeFolderLabel');
            if (activeFolderId && activeFolderName) {
                label.textContent = activeFolderName;
                label.classList.remove('hidden');
            } else {
                label.textContent = '';
                label.classList.add('hidden');
            }
        }

        async function renderFolderConversations() {
            if (!token) return;
            const folderContainer = document.getElementById('folderList');
            const convContainer = document.getElementById('conversationList');
            const allBtn = document.getElementById('allConvBtn');

            if (allBtn) {
                if (!activeFolderId) {
                    allBtn.classList.add('active');
                } else {
                    allBtn.classList.remove('active');
                }
            }

            let folderHtml = '';
            if (folders.length === 0) {
                folderHtml = '<p class="text-xs text-gray-400 dark:text-gray-500 py-1">No topics yet. Click "+ Topic" to create one.</p>';
            } else {
                folderHtml = '<div class="flex flex-wrap gap-1">' + folders.map(f => `
                    <div class="folder-item px-2 py-1 text-xs rounded flex items-center gap-1 group ${activeFolderId === f.id ? 'active' : ''}" 
                         onclick="selectFolder(${f.id}, '${f.name.replace(/'/g, "\\'")}')">
                        <svg class="w-3.5 h-3.5 text-yellow-500 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
                        <span class="text-gray-700 dark:text-gray-300 truncate" style="max-width: 120px;">${f.name}</span>
                        <span class="text-gray-400">${f.conversation_count}</span>
                        <button onclick="event.stopPropagation(); renameFolder(${f.id}, '${f.name.replace(/'/g, "\\'")}')" class="hidden group-hover:inline text-gray-400 hover:text-blue-500 ml-0.5" title="Rename">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                        </button>
                        <button onclick="event.stopPropagation(); deleteFolder(${f.id}, '${f.name.replace(/'/g, "\\'")}')" class="hidden group-hover:inline text-gray-400 hover:text-red-500" title="Delete">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                `).join('') + '</div>';
            }
            folderContainer.innerHTML = folderHtml;

            let convHtml = '';
            try {
                let convs = [];
                if (activeFolderId) {
                    const res = await fetch(`${API_BASE}/api/folders/${activeFolderId}/conversations`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) convs = await res.json();
                } else {
                    const res = await fetch(`${API_BASE}/api/chat/sessions`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) convs = await res.json();
                }
                if (convs.length > 0) {
                    convHtml = '<div class="text-xs text-gray-400 dark:text-gray-500 uppercase tracking-wide mb-1">Recent Conversations</div>';
                    convHtml += convs.map(c => `
                        <div class="conv-item px-2 py-1 ${chatSessionId === c.session_id ? 'active' : ''}"
                             onclick="loadConversation('${c.session_id}')">
                            <p class="text-xs text-gray-600 dark:text-gray-400 truncate">${c.preview}</p>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Error loading conversations:', err);
            }
            convContainer.innerHTML = convHtml;
        }

        async function loadConversation(sessionId) {
            chatSessionId = sessionId;
            localStorage.setItem('chatSessionId', sessionId);
            await loadChatHistory();
            renderFolderConversations();
        }

        async function renameFolder(folderId, currentName) {
            const newName = prompt('Rename topic:', currentName);
            if (!newName || newName.trim() === '' || newName === currentName) return;
            try {
                const res = await fetch(`${API_BASE}/api/folders/${folderId}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName.trim() })
                });
                if (!res.ok) throw new Error('Failed to rename');
                if (activeFolderId === folderId) {
                    activeFolderName = newName.trim();
                    localStorage.setItem('activeFolderName', activeFolderName);
                    updateActiveFolderLabel();
                }
                await loadFolders();
            } catch (err) {
                alert('Error renaming topic: ' + err.message);
            }
        }

        async function deleteFolder(folderId, folderName) {
            if (!confirm(`Delete topic "${folderName}"? Conversations will be kept but unlinked from this topic.`)) return;
            try {
                const res = await fetch(`${API_BASE}/api/folders/${folderId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Failed to delete');
                if (activeFolderId === folderId) {
                    selectFolder(null);
                }
                await loadFolders();
            } catch (err) {
                alert('Error deleting topic: ' + err.message);
            }
        }
        
        async function loadChatHistory() {
            if (!chatSessionId || !token) return;
            try {
                const res = await fetch(`${API_BASE}/api/chat/history?session_id=${encodeURIComponent(chatSessionId)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) return;
                const messages = await res.json();
                if (messages.length === 0) {
                    startNewConversation();
                    return;
                }
                const container = document.getElementById('chatMessages');
                container.innerHTML = '';
                for (const msg of messages) {
                    addMessage(msg.content, msg.role === 'user', msg.sources || []);
                }
                const firstUserMsg = messages.find(m => m.role === 'user');
                if (firstUserMsg) {
                    updateConversationLabel(firstUserMsg.content);
                }
            } catch (err) {
                console.error('Error loading chat history:', err);
            }
        }

        // Tab switching
        function switchTab(tab) {
            const askTab = document.getElementById('tabAskQuestions');
            const analyzeTab = document.getElementById('tabAnalyzePleading');
            const askContent = document.getElementById('askQuestionsContent');
            const analyzeContent = document.getElementById('analyzePleadingContent');
            
            if (tab === 'ask') {
                askTab.classList.add('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
                askTab.classList.remove('border-transparent', 'text-gray-500');
                analyzeTab.classList.remove('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
                analyzeTab.classList.add('border-transparent', 'text-gray-500');
                askContent.classList.remove('hidden');
                analyzeContent.classList.add('hidden');
            } else {
                analyzeTab.classList.add('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
                analyzeTab.classList.remove('border-transparent', 'text-gray-500');
                askTab.classList.remove('border-blue-600', 'text-blue-600', 'dark:text-blue-400');
                askTab.classList.add('border-transparent', 'text-gray-500');
                analyzeContent.classList.remove('hidden');
                askContent.classList.add('hidden');
                updatePleadingSelect();
            }
        }
        
        function updatePleadingSelect() {
            const select = document.getElementById('pleadingSelect');
            const currentValue = select.value;
            fetch(`${API_BASE}/api/documents`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => {
                if (!res.ok) throw new Error('Failed to load documents');
                return res.json();
            })
            .then(docs => {
                const readyDocs = docs.filter(d => d.status === 'ready');
                select.innerHTML = '<option value="">-- Select a document to analyze --</option>' +
                    readyDocs.map(d => `<option value="${d.id}">${d.original_filename}</option>`).join('');
                if (currentValue && readyDocs.some(d => d.id == currentValue)) {
                    select.value = currentValue;
                }
            })
            .catch(err => {
                console.error('Error loading documents for analysis:', err);
                select.innerHTML = '<option value="">Error loading documents - try refreshing</option>';
            });
        }
        
        async function analyzePleading() {
            const docId = document.getElementById('pleadingSelect').value;
            if (!docId) {
                alert('Please select a document to analyze');
                return;
            }
            
            const btn = document.getElementById('analyzeBtn');
            const results = document.getElementById('analysisResults');
            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            results.innerHTML = `
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-4"></div>
                    <p class="text-gray-600 dark:text-gray-400">Analyzing legal issues and searching for evidence...</p>
                    <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">This may take a minute...</p>
                </div>
            `;
            
            try {
                const formData = new FormData();
                formData.append('doc_id', docId);
                
                const res = await fetch(`${API_BASE}/api/analyze-pleading`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ detail: 'Analysis failed' }));
                    throw new Error(errorData.detail || 'Analysis failed');
                }
                
                const data = await res.json();
                renderAnalysisResults(data);
            } catch (err) {
                results.innerHTML = `
                    <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg">
                        <h4 class="font-medium text-red-800 dark:text-red-300">Analysis Error</h4>
                        <p class="text-red-700 dark:text-red-400 mt-1">${err.message}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Try selecting a different document or refreshing the page.</p>
                    </div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Analyze';
            }
        }
        
        async function analyzeUploadedPleading() {
            const fileInput = document.getElementById('pleadingFileInput');
            if (!fileInput.files || !fileInput.files[0]) {
                alert('Please select a file to upload and analyze');
                return;
            }
            
            const file = fileInput.files[0];
            const btn = document.getElementById('analyzeUploadBtn');
            const results = document.getElementById('analysisResults');
            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            results.innerHTML = `
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-4"></div>
                    <p class="text-gray-600 dark:text-gray-400">Uploading and analyzing "${file.name}"...</p>
                    <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">This document will not be saved to your knowledge base.</p>
                </div>
            `;
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const res = await fetch(`${API_BASE}/api/analyze-pleading-upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ detail: 'Analysis failed' }));
                    throw new Error(errorData.detail || 'Analysis failed');
                }
                
                const data = await res.json();
                renderAnalysisResults(data);
                fileInput.value = '';
            } catch (err) {
                results.innerHTML = `
                    <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg">
                        <h4 class="font-medium text-red-800 dark:text-red-300">Analysis Error</h4>
                        <p class="text-red-700 dark:text-red-400 mt-1">${err.message}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Try a different file or check the file format.</p>
                    </div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Analyze Upload';
            }
        }
        
        function renderAnalysisResults(data) {
            const results = document.getElementById('analysisResults');
            
            let html = `
                <div class="mb-6 p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                    <h3 class="font-semibold text-purple-800 dark:text-purple-300 mb-2">Pleading Summary</h3>
                    <p class="text-gray-700 dark:text-gray-300">${data.pleading_summary}</p>
                </div>
            `;
            
            if (data.issues.length === 0) {
                html += '<p class="text-gray-500">No legal issues extracted from this document.</p>';
            } else {
                html += '<h3 class="font-semibold text-lg mb-4 dark:text-white">Legal Issues</h3>';
                
                data.issues.forEach((item, idx) => {
                    const issue = item.issue;
                    const supporting = item.supporting_evidence || [];
                    const contradicting = item.contradicting_evidence || [];
                    
                    html += `
                        <div class="mb-6 border dark:border-gray-700 rounded-lg overflow-hidden">
                            <div class="bg-gray-100 dark:bg-gray-700 p-4">
                                <h4 class="font-semibold dark:text-white">Issue ${issue.issue_number}: ${issue.issue_title}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${issue.summary}</p>
                                <div class="mt-2">
                                    ${issue.key_claims.map(c => `<span class="inline-block bg-gray-200 dark:bg-gray-600 text-xs px-2 py-1 rounded mr-1 mb-1">${c}</span>`).join('')}
                                </div>
                            </div>
                            <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h5 class="font-medium text-green-700 dark:text-green-400 mb-2 flex items-center">
                                        <span class="mr-1">&#10003;</span> Supporting Evidence (${supporting.length})
                                    </h5>
                                    ${supporting.length === 0 ? '<p class="text-sm text-gray-500">No supporting evidence found</p>' :
                                        supporting.map(e => `
                                            <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded mb-2 text-sm">
                                                <p class="font-medium text-green-800 dark:text-green-300">${e.doc_name}</p>
                                                <p class="text-gray-700 dark:text-gray-300 mt-1">"${e.excerpt}"</p>
                                                <p class="text-xs text-green-600 dark:text-green-400 mt-1">${e.reasoning}</p>
                                                ${e.page_numbers.length ? `<p class="text-xs text-gray-500 mt-1">Pages: ${e.page_numbers.join(', ')}</p>` : ''}
                                            </div>
                                        `).join('')
                                    }
                                </div>
                                <div>
                                    <h5 class="font-medium text-red-700 dark:text-red-400 mb-2 flex items-center">
                                        <span class="mr-1">&#10007;</span> Contradicting Evidence (${contradicting.length})
                                    </h5>
                                    ${contradicting.length === 0 ? '<p class="text-sm text-gray-500">No contradicting evidence found</p>' :
                                        contradicting.map(e => `
                                            <div class="bg-red-50 dark:bg-red-900/20 p-3 rounded mb-2 text-sm">
                                                <p class="font-medium text-red-800 dark:text-red-300">${e.doc_name}</p>
                                                <p class="text-gray-700 dark:text-gray-300 mt-1">"${e.excerpt}"</p>
                                                <p class="text-xs text-red-600 dark:text-red-400 mt-1">${e.reasoning}</p>
                                                ${e.page_numbers.length ? `<p class="text-xs text-gray-500 mt-1">Pages: ${e.page_numbers.join(', ')}</p>` : ''}
                                            </div>
                                        `).join('')
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            results.innerHTML = html;
        }

        // Event listeners
        document.getElementById('authToggle').addEventListener('click', toggleAuthMode);
        document.getElementById('authForm').addEventListener('submit', handleAuth);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files.length > 0) uploadFiles(e.target.files);
        });
        document.getElementById('chatForm').addEventListener('submit', handleChat);
        
        // Resizable panel functionality
        const resizer = document.getElementById('resizer');
        const documentsPanel = document.getElementById('documentsPanel');
        let isResizing = false;
        
        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizer.classList.add('resizing');
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const containerRect = documentsPanel.parentElement.getBoundingClientRect();
            let newWidth = e.clientX - containerRect.left;
            newWidth = Math.max(250, Math.min(600, newWidth));
            documentsPanel.style.width = newWidth + 'px';
            localStorage.setItem('documentsPanelWidth', newWidth);
        });
        
        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                resizer.classList.remove('resizing');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });
        
        // Restore saved width
        const savedWidth = localStorage.getItem('documentsPanelWidth');
        if (savedWidth) {
            documentsPanel.style.width = savedWidth + 'px';
        }

        // Restore folder panel state (open by default)
        if (localStorage.getItem('folderPanelOpen') === 'false') {
            document.getElementById('folderPanel').classList.add('collapsed');
            document.getElementById('folderChevron').style.transform = 'rotate(-90deg)';
        }
        updateActiveFolderLabel();

        // Init
        if (token) {
            hideAuth();
            document.getElementById('userDisplay').textContent = localStorage.getItem('username') || 'User';
            loadDocuments();
            loadFolders().then(() => renderFolderConversations());
            loadChatHistory();
        } else {
            showAuth();
        }
    </script>
</body>
</html>
